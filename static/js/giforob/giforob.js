// ⠀⠀⠀⠀⠀⢀⣤⣔⠲⢤⡖⢶⣶⣤⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⡤⣴⠢⣄⡀⠀
// ⠀⢀⣤⣤⠤⣜⡿⠭⡤⠈⢳⣤⣀⡈⢳⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣤⡤⢶⣿⡀⣠⣿⣴⣻⡇⠀
// ⠀⠘⠓⠓⢶⠈⢹⢀⡟⠀⣼⣡⠏⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠁⣇⣻⣾⢻⠁⣨⣿⣭⣀⠀
// ⠀⠀⠀⢠⡿⠒⠋⠉⣉⣛⡻⠄⢀⡴⠋⠀⠀⠀⢀⣠⡶⠟⠉⠉⠉⠉⠛⠷⣦⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢳⣀⣨⣇⣀⣸⣟⢁⣴⣻⣼⣷
// ⠀⢀⡶⠋⠐⠒⠒⠒⣏⠨⠭⠗⢯⡀⠀⠀⠀⣠⠟⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⣦⠀⠀⠀⠀⠀⠀⠀⢀⣠⠖⠻⠽⢩⡏⠀⠀⠉⢹⡟⠛⠋⠁
// ⠀⣼⣄⠀⠀⣰⠖⠑⠺⣗⠲⠆⢠⠇⠀⠀⢠⡏⠀⠀⠀⠀⣴⣻⣷⡆⠀⠀⠀⠀⠘⡇⠀⠀⠀⠀⠀⠀⢸⠁⠐⢶⣶⠯⠿⣕⠚⠁⠈⠻⡆⠀⠀
// ⢰⡟⡏⠒⠲⣄⠀⠀⠀⠈⢂⣠⠟⠀⠀⢀⣼⡇⠀⠀⠀⠀⠻⣿⡿⠃⠀⠀⠀⠀⠀⡏⠓⢦⣄⠀⠀⠀⠸⣆⠀⠈⠁⠀⠀⠼⠀⡀⠀⣠⣇⠀⠀
// ⢸⡿⣷⠀⠀⠈⠓⠲⣶⠞⠉⠁⠀⢀⣴⠟⠉⢷⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣴⠇⠀⠀⠈⢳⡀⠀⠀⠙⠷⣄⣀⣀⣀⡠⠞⠉⠉⣿⣼⠀⠀
// ⣿⣇⠈⠃⠀⠀⠀⢰⣇⣄⠀⠀⠀⡜⠁⠀⠀⠈⠻⣦⡀⠀⠀⠀⠀⠀⠀⢀⣠⡾⠃⠀⠀⠀⠀⠀⢻⡀⠀⠀⠀⠀⣹⠉⠉⠀⠀⠀⢸⠟⡝⠀⠀
// ⡏⠛⠀⠀⠀⠀⠀⢸⣿⣗⠀⠀⣼⡥⠖⠒⠀⠀⠀⠈⠙⠻⠶⠶⠶⠶⠾⢛⠁⠀⠀⠀⠀⡀⠈⠉⠲⣇⠀⠀⠀⣸⣿⠀⠀⠀⠀⠀⠀⣰⣳⡄⠀
// ⢹⡄⠀⠀⠀⠀⠀⠀⠙⢿⣇⢰⠏⠀⢠⣶⢶⣦⣄⡀⠀⠀⠉⠒⠒⠒⠋⠁⠀⠀⣀⣴⣿⣿⣿⣦⠀⠘⡇⢀⣿⠟⠁⠀⠀⠀⠀⠀⠰⠋⢸⡇⠀
// ⠸⣷⠀⠀⠀⠀⠀⠀⠀⠘⠻⣾⠀⠀⢸⣿⣿⣧⣈⣿⣷⣤⣀⠀⠀⠀⠀⣀⣠⣾⣯⣼⣿⠛⣿⠏⠀⠀⢸⡟⠋⠀⠀⠀⠀⠀⠀⠀⠀⢀⡞⠀⠀
// ⠀⠙⣆⠀⠀⠀⠀⠀⠀⠀⠀⢿⠀⠀⠈⠻⣿⡿⢿⣿⣿⠀⠉⢻⣿⣿⣿⣿⣿⠛⠻⣿⣿⠟⠋⠀⠀⠀⡼⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⡞⠀⠀⠀
// ⠀⠀⠈⣷⡄⠀⠀⠀⠀⠀⠀⠸⣧⡄⠀⠀⠈⠙⠶⠼⣿⣿⣶⣿⣿⣿⣿⣀⣿⠶⠖⠋⠁⠀⠀⠀⠀⣸⠃⠀⠀⠀⠀⠀⠀⠀⠀⡴⡿⠃⠀⠀⠀
// ⠀⠀⠀⠈⢿⡳⠀⠀⠀⠀⠀⠀⠹⣽⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⠀⠀⠀⠀⢠⠀⣠⡾⠃⠀⠀⠀⠀⠀⠀⠀⢀⣴⡟⠁⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⣿⢦⠀⠀⠀⠀⠀⠀⠙⢯⠷⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡴⣟⡼⠋⠀⠀⠀⠀⠀⠀⠀⠀⣠⡼⠋⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠈⠷⣄⠀⠀⠀⠀⠀⠀⠀⠁⠘⠳⣤⢢⣄⠀⠀⠀⠀⠀⠀⣀⡀⢀⡴⠋⣰⠟⠀⠀⠀⠀⠀⠀⠀⢀⣤⠞⠁⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠈⠳⣄⠀⠀⠀⠀⡀⠀⠀⠀⠀⠉⠻⠿⠲⢬⣆⣠⣞⣿⡵⢫⠖⠁⠀⠀⠀⠀⠀⡾⠁⠀⠀⣸⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢣⡀⠀⠀⢹⡀⡀⠀⠀⠀⠀⠀⠀⠀⠈⠋⠘⠈⡴⠃⠀⠀⠀⠀⠀⢀⡾⠁⠀⠀⢰⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢳⠀⠀⠀⠻⡿⣄⡀⣦⡀⠀⠀⠀⠀⠀⠀⠚⠁⠀⣀⡀⢀⣠⣾⡟⠀⠀⠀⠀⢸⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣧⠤⠄⠀⠹⠌⠓⣿⠙⠷⣄⠀⠀⠀⡄⠀⣠⡴⣿⡵⠟⠹⠋⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣏⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠈⠱⣄⣼⣿⠞⠋⠈⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠟⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⡀⠀⠀⠀⠀⠀⢀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢳⣠⡀⠀⠀⠀⡟⠳⠤⣄⣀⣀⠀⠀⠀⢀⣀⣀⣠⠤⠴⠚⡄⠀⠀⠀⠀⢀⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⣀⣀⠀⠹⡷⣄⠀⠀⣷⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠁⠀⠀⠀⣀⡇⠀⠀⢀⣴⡞⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⣠⢞⣁⣀⣀⣀⣈⣓⣤⣀⠙⣆⡀⠘⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⡾⣿⠁⣠⠴⢯⣽⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⢸⡟⡏⠁⠀⣀⣀⡽⠿⢿⣿⣷⢯⡩⠗⢻⣦⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⢿⣟⠋⢹⣁⣀⣰⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠘⢧⢷⡖⠿⠟⢛⣏⠙⠲⡌⢻⣷⣷⢤⣀⠚⣧⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⢦⢻⡘⣆⣨⠵⠚⠛⠛⠳⢦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠈⠛⢿⣆⡘⢉⣈⡉⠉⠙⠉⣁⣬⠟⡺⢵⣾⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣧⠳⣼⣉⠀⠀⠀⠀⠀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠙⠛⠒⠛⠿⢾⣵⣞⠁⠀⠒⣹⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠻⣄⣀⠉⠉⠙⠛⢛⣛⡫⠟⠀⠀⠀⠀⠀⠀⠀⠀⠀
// ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠉⠉⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠉⠉⠉⠉⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

import { DotLottie } from '/static/js/lottie-player/dotlottie-web.mjs';
import { fetchFile } from '/static/js/ffmpeg/util/esm/index.js';
import { logger } from '/static/js/giforob/utils/logger.js'
import { newIcon, drawTextBox, drawBackground } from '/static/js/giforob/drawing/drawing.js';
import {unpackTgs, downloadBlob, hexToRGB} from '/static/js/giforob/utils/utils.js';
import { loadFFMpeg } from '/static/js/giforob/utils/ffmpeg.js';

logger('Loading FFMpeg, please wait...');
let ffmpeg = await loadFFMpeg();

const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');

const lottieCanvas = document.createElement('canvas');
lottieCanvas.width = 650;
lottieCanvas.height = 650;

const response = await fetch('/static/media/create.tgs');
const arrayBuffer = await response.arrayBuffer();
let sticker = await unpackTgs(arrayBuffer);

let dotLottie = new DotLottie({autoplay: false, loop: false, canvas: lottieCanvas, data: sticker});

const playButton = document.getElementById('play');
const stopButton = document.getElementById('stop');
const renderButton = document.getElementById('render');

let text = document.getElementById('text').value;
let paddingX = parseInt(document.getElementById('padding-x').value);
let paddingY = parseInt(document.getElementById('padding-y').value);
let color = document.getElementById('hex-color-text').value;
let icon = newIcon({src: '/static/icons/templates/smile.svg', color: `#${color}`, width: 80, height: 80});
let backgroundColor = document.getElementById('hex-background-color-text').value;

let borderColor = document.getElementById('hex-border-color').value;
let borderRadius = document.getElementById('border-radius').value;
let borderWidth = document.getElementById('border-width').value;

let backgroundColor1 = hexToRGB(document.getElementById('hex-background-color1').value);
let backgroundColor2 = hexToRGB(document.getElementById('hex-background-color2').value);
let backgroundColor3 = hexToRGB(document.getElementById('hex-background-color3').value);
let backgroundColor4 = hexToRGB(document.getElementById('hex-background-color4').value);

let opacityColor1 = parseInt(document.getElementById('opacity-color1').value) / 100;
let opacityColor2 = parseInt(document.getElementById('opacity-color2').value) / 100;
let opacityColor3 = parseInt(document.getElementById('opacity-color3').value) / 100;
let opacityColor4 = parseInt(document.getElementById('opacity-color4').value) / 100;

playButton.addEventListener('click', () => {
  logger('Play animation');

  playButton.classList.add('d-none');
  stopButton.classList.remove('d-none');

  renderButton.disabled = true;

  dotLottie.play();
  dotLottie.setLoop(true);
});

stopButton.addEventListener('click', () => {
  logger('Stop animation');

  stopButton.classList.add('d-none');
  playButton.classList.remove('d-none');

  renderButton.disabled = false;

  dotLottie.stop();
  dotLottie.setLoop(false);
});

renderButton.addEventListener('click', async () => {
  playButton.disabled = true;
  renderButton.disabled = true;

  logger('Starting render');

  await ffmpeg.createDir('/temp')

  for (let i = 0; i <= (sticker.op - sticker.ip + 1); i++) {
    dotLottie.setFrame(i);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    const fileName = `img${String(i + 1).padStart(3, '0')}.png`;

    await ffmpeg.writeFile(`/temp/${fileName}`, await fetchFile(blob));
    logger(`File: ${fileName} written to file system`);
  }

  logger('Encoding your video');

  await ffmpeg.exec(
    [
      '-framerate', '60',
      '-i', '/temp/img%03d.png',
      '-c:v', 'libx264',
      '-pix_fmt', 'yuv420p',
      '-crf', '24',
      '-preset', 'medium',
      '-bufsize', '3M',
      '-maxrate', '5M',
      '-movflags', '+faststart',
      '-f', 'mp4',
      'output.mp4'
    ]
  );

  logger('The video is ready, the download will start soon');
  const data = await ffmpeg.readFile('output.mp4');
  downloadBlob(data, `${text.toLowerCase().replaceAll(' ', '-')}.mp4`);

  logger('Rendered video successfully!');

  let items = await ffmpeg.listDir('/temp')
  for (let item of items) {
      if (!item.isDir) {
          await ffmpeg.deleteFile(`/temp/${item.name}`);
      }
  }
  logger('Deleting cache...')

  await ffmpeg.deleteDir('/temp')

  logger('Cleared out cache successfully!');

  playButton.disabled = false;
  renderButton.disabled = false;
});

function renderFrame() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  drawBackground({
    ctx: ctx,
    canvas: canvas,
    color1: backgroundColor1,
    opacity1: opacityColor1,
    color2: backgroundColor2,
    opacity2:opacityColor2,
    color3: backgroundColor3,
    opacity3:opacityColor3,
    color4: backgroundColor4,
    opacity4:opacityColor4
  });

  ctx.drawImage(lottieCanvas, 215, 553, lottieCanvas.width, lottieCanvas.height);

  drawTextBox(ctx, text, icon, 553 + lottieCanvas.height, paddingX, paddingY, `#${color}`, `#${backgroundColor}`, `#${borderColor}`, borderRadius, borderWidth);

  requestAnimationFrame(renderFrame);
}

async function uploadSticker() {
  const input = document.getElementById('sticker');
  const reader = new FileReader();

  reader.readAsArrayBuffer(input.files[0]);

  reader.onload = async function(event) {
    sticker = await unpackTgs(event.target.result);

    dotLottie.load({data: sticker});
  };

  reader.onerror = function(event) {
    console.error('Read file error:', event.target.error);
  };
}

async function uploadIcon() {
  const reader = new FileReader();

  reader.readAsDataURL(document.getElementById('icon').files[0]);

  reader.onload = async function(event) {
    icon = newIcon({
    src: event.target.result,
    color: '#ffaf4d',
    width: 80,
    height: 80
  });
  };

  reader.onerror = function(event) {
    console.error('Read file error:', event.target.error);
  };
}

function applySettings() {
  text = document.getElementById('text').value;
  paddingX = parseInt(document.getElementById('padding-x').value);
  paddingY = parseInt(document.getElementById('padding-y').value);
  color = document.getElementById('hex-color-text').value;
  backgroundColor = document.getElementById('hex-background-color-text').value;

  borderColor = document.getElementById('hex-border-color').value;
  borderRadius = parseInt(document.getElementById('border-radius').value);
  borderWidth = parseInt(document.getElementById('border-width').value);

  backgroundColor1 = hexToRGB(document.getElementById('hex-background-color1').value);
  backgroundColor2 = hexToRGB(document.getElementById('hex-background-color2').value);
  backgroundColor3 = hexToRGB(document.getElementById('hex-background-color3').value);
  backgroundColor4 = hexToRGB(document.getElementById('hex-background-color4').value);

  opacityColor1 = parseInt(document.getElementById('opacity-color1').value) / 100;
  opacityColor2 = parseInt(document.getElementById('opacity-color2').value) / 100;
  opacityColor3 = parseInt(document.getElementById('opacity-color3').value) / 100;
  opacityColor4 = parseInt(document.getElementById('opacity-color4').value) / 100;
}

async function changeColor(element) {
  document.getElementById('hex-' + element.id).value = element.value.replace('#', '')

  await applySettings()
}

async function changeHexColor(element) {
  if (element.value.includes('#')) {
    element.value = element.value.replace('#', '')
  }

  document.getElementById(element.id.replace('hex-', '')).value = '#' + element.value

  await applySettings()
}

document.getElementById('sticker').addEventListener('change', uploadSticker)
document.getElementById('icon').addEventListener('change', uploadIcon)

document.getElementById('text').addEventListener('keyup', applySettings);
document.getElementById('padding-x').addEventListener('change', applySettings);
document.getElementById('padding-y').addEventListener('change', applySettings);

document.getElementById('color-text').addEventListener('input', async function () {await changeColor(this)});
document.getElementById('hex-color-text').addEventListener('change', async function () {await changeHexColor(this)});
document.getElementById('background-color-text').addEventListener('input', async function () {await changeColor(this)});
document.getElementById('hex-background-color-text').addEventListener('change', async function () {await changeHexColor(this)});

document.getElementById('border-color').addEventListener('input', async function () {await changeColor(this)});
document.getElementById('hex-border-color').addEventListener('change', async function () {await changeHexColor(this)});
document.getElementById('border-radius').addEventListener('change', applySettings);
document.getElementById('border-width').addEventListener('change', applySettings);

document.getElementById('background-color1').addEventListener('input', async function () {await changeColor(this)});
document.getElementById('hex-background-color1').addEventListener('change', async function () {await changeHexColor(this)});
document.getElementById('background-color2').addEventListener('input', async function () {await changeColor(this)});
document.getElementById('hex-background-color2').addEventListener('change', async function () {await changeHexColor(this)});
document.getElementById('background-color3').addEventListener('input', async function () {await changeColor(this)});
document.getElementById('hex-background-color3').addEventListener('change', async function () {await changeHexColor(this)});
document.getElementById('background-color4').addEventListener('input', async function () {await changeColor(this)});
document.getElementById('hex-background-color4').addEventListener('change', async function () {await changeHexColor(this)});

document.getElementById('opacity-color1').addEventListener('change', applySettings);
document.getElementById('opacity-color2').addEventListener('change', applySettings);
document.getElementById('opacity-color3').addEventListener('change', applySettings);
document.getElementById('opacity-color4').addEventListener('change', applySettings);

dotLottie.addEventListener('load', renderFrame);
